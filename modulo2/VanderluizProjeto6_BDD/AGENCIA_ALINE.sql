CREATE DATABASE AGENCIA_ALINE;

/*1- CRIAÇÃO DAS TABELAS*/
CREATE TABLE CLIENTES(
    CPF BIGINT NOT NULL,
    NOME NVARCHAR(255) NOT NULL,
    DATA_NASCIMENTO DATETIME NOT NULL,
    CONSTRAINT PK_CLIENTES PRIMARY KEY  (CPF)
);

CREATE TABLE CESTAS(
    ID INT IDENTITY(1,1) NOT NULL,
    DESCRICAO NVARCHAR(255) NOT NULL,
    VALOR FLOAT NOT NULL,
    CONSTRAINT PK_CESTAS PRIMARY KEY  (ID)
);

CREATE TABLE CONTRATOS(
    ID INT IDENTITY(1,1) NOT NULL,
    TIPO NVARCHAR(100) NOT NULL,
    VALOR_TOTAL FLOAT NOT NULL,
    QTD_PARCELAS INT NOT NULL,
    CPF_CLIENTES BIGINT NOT NULL,
    CONSTRAINT PK_CONTRATOS PRIMARY KEY (ID),
    CONSTRAINT FK_CLIENTES FOREIGN KEY (CPF_CLIENTES) REFERENCES CLIENTES (CPF)    
);

CREATE TABLE CONTAS(
    NUMERO INT NOT NULL,
    DIGITO INT NOT NULL,
    AGENCIA INT NOT NULL,
    TIPO INT NOT NULL,
    SALDO FLOAT NOT NULL,
    LIMITE FLOAT NOT NULL,
    DATA_ABERTURA DATETIME NOT NULL,
    ID_CESTAS INT NULL,
    CPF_CLIENTES BIGINT NOT NULL,
    CONSTRAINT PK_CONTAS PRIMARY KEY (NUMERO),
    CONSTRAINT FK_CESTAS FOREIGN KEY (ID_CESTAS) REFERENCES CESTAS(ID),
    CONSTRAINT FK_CLIENTE FOREIGN KEY (CPF_CLIENTES) REFERENCES CLIENTES (CPF) 
);

/*2 - INSERINDO OS DADOS DAS PLANILHAS NAS TABELAS*/

INSERT INTO CLIENTES(CPF, NOME, DATA_NASCIMENTO) VALUES (25520831025, 'Enzo Ribeiro', '18/6/1995');
INSERT INTO CLIENTES(CPF, NOME, DATA_NASCIMENTO) VALUES (27446351039, 'Maria Mendes', '1/8/1971');
INSERT INTO CLIENTES(CPF, NOME, DATA_NASCIMENTO) VALUES (78014068009, 'Nilson Souza', '22/7/1963');
INSERT INTO CLIENTES(CPF, NOME, DATA_NASCIMENTO) VALUES (93260976094, 'Marina Delfes', '25/11/2002');
INSERT INTO CLIENTES(CPF, NOME, DATA_NASCIMENTO) VALUES (97945506046, 'Alberto Rodrigues', '19/4/1987');


INSERT INTO CESTAS(DESCRICAO, VALOR) VALUES('Platina', 12.50);
INSERT INTO CESTAS(DESCRICAO, VALOR) VALUES('Prata', 25.50);
INSERT INTO CESTAS(DESCRICAO, VALOR) VALUES('Ouro', 40.50);


INSERT INTO CONTRATOS(TIPO, VALOR_TOTAL, QTD_PARCELAS, CPF_CLIENTES) VALUES ('Habitacional', 350000.00, 200, 25520831025);
INSERT INTO CONTRATOS(TIPO, VALOR_TOTAL, QTD_PARCELAS, CPF_CLIENTES) VALUES ('Consignado', 50000.00, 30, 27446351039);
INSERT INTO CONTRATOS(TIPO, VALOR_TOTAL, QTD_PARCELAS, CPF_CLIENTES) VALUES ('CDC', 2000.00, 10, 78014068009);
INSERT INTO CONTRATOS(TIPO, VALOR_TOTAL, QTD_PARCELAS, CPF_CLIENTES) VALUES ('Habitacional', 100000.00, 150, 93260976094);
INSERT INTO CONTRATOS(TIPO, VALOR_TOTAL, QTD_PARCELAS, CPF_CLIENTES) VALUES ('CDC', 3500.00, 7, 97945506046);


INSERT INTO CONTAS(NUMERO, DIGITO, AGENCIA, TIPO, SALDO, LIMITE, DATA_ABERTURA, ID_CESTAS, CPF_CLIENTES) VALUES(12345, 4, 0420, 001, 1500.00, 200, '1/1/2022', 3, 97945506046);
INSERT INTO CONTAS(NUMERO, DIGITO, AGENCIA, TIPO, SALDO, LIMITE, DATA_ABERTURA, ID_CESTAS, CPF_CLIENTES) VALUES(12457, 0, 0420, 1288, 2400.00, 200.00, '1/8/2022', NULL, 78014068009);
INSERT INTO CONTAS(NUMERO, DIGITO, AGENCIA, TIPO, SALDO, LIMITE, DATA_ABERTURA, ID_CESTAS, CPF_CLIENTES) VALUES(15742, 1, 1665, 013, 3500.00, 200.00, '12/1/2012', NULL, 27446351039);
INSERT INTO CONTAS(NUMERO, DIGITO, AGENCIA, TIPO, SALDO, LIMITE, DATA_ABERTURA, ID_CESTAS, CPF_CLIENTES) VALUES(25412, 2, 0420, 001, 11500.00, 200.00, '31/7/2022', 1, 93260976094);
INSERT INTO CONTAS(NUMERO, DIGITO, AGENCIA, TIPO, SALDO, LIMITE, DATA_ABERTURA, ID_CESTAS, CPF_CLIENTES) VALUES(35715, 5, 3885, 1288, 2500.00, 200.00, '11/1/1999', NULL, 25520831025);
INSERT INTO CONTAS(NUMERO, DIGITO, AGENCIA, TIPO, SALDO, LIMITE, DATA_ABERTURA, ID_CESTAS, CPF_CLIENTES) VALUES(78945, 4, 3285, 001, 15000.00, 200.00, '1/1/2022', 2, 78014068009);
INSERT INTO CONTAS(NUMERO, DIGITO, AGENCIA, TIPO, SALDO, LIMITE, DATA_ABERTURA, ID_CESTAS, CPF_CLIENTES) VALUES(89562, 0, 0420, 013, 500.00, 200.00, '2/2/2022', NULL, 97945506046);

/*3 - MOSTRANDO NOME, NUMERO, AGENCIA E SALDO DOS CLIENTES*/
SELECT CLIENTES.NOME, CONTAS.NUMERO, CONTAS.AGENCIA, CONTAS.SALDO 
FROM CLIENTES, CONTAS
WHERE CLIENTES.CPF = CONTAS.CPF_CLIENTES

/*4 - MOSTRANDO DADOS DA TABELA CLIENTES E CONTRATOS*/
SELECT CLIENTES.NOME, CONTRATOS.TIPO, CONTRATOS.VALOR_TOTAL, CONTRATOS.QTD_PARCELAS 
FROM CLIENTES, CONTRATOS
WHERE CLIENTES.CPF = CONTRATOS.CPF_CLIENTES

/*5 - MOSTRANDO CONTAS COM CESTAS*/
SELECT * 
FROM CESTAS, CONTAS
WHERE CESTAS.ID = CONTAS.ID_CESTAS

/*6 - CONTAS QUE NÃO POSSUEM CESTAS*/
SELECT * 
FROM CONTAS
WHERE CONTAS.ID_CESTAS IS NULL;

/*7 - TOTAL DE CONTAS, CONTRATOS E CLIENTES*/
SELECT COUNT(*) AS [TOTAL DE CLIENTES]
FROM CLIENTES
GO
SELECT COUNT(*) AS [TOTAL DE CONTAS]
FROM CONTAS
GO
SELECT COUNT(*) AS [TOTAL DE CONTRATOS]
FROM CONTRATOS
GO

/*8 - CONTAS ABERTAS EM 2022*/
SELECT COUNT(*) AS [TOTAL DE CONTAS ABERTAS EM 2022]
FROM CONTAS
WHERE DATA_ABERTURA >= '1-1-2022'

/*9.1 - MEDIA DO VALOR TOTAL DOS CONTRATOS*/
SELECT AVG(VALOR_TOTAL) AS [MEDIA DO VALOR TOTAL]
FROM CONTRATOS

/*9.2 - MAIOR VALOR TOTAL*/
SELECT MAX(VALOR_TOTAL) AS [MAIR VALOR TOTAL]
FROM CONTRATOS

/*9.3 - SOMA VALOR TOTAL HABITACIONAL*/
SELECT SUM(VALOR_TOTAL) AS [SOMA VALOR TOTAL HABITACIONAL]
FROM CONTRATOS
WHERE TIPO = 'Habitacional'

/*10 - DELETANDO OS DADOS DAS TABELAS*/
DELETE FROM CONTAS;
DELETE FROM CONTRATOS;
DELETE FROM CLIENTES;
DELETE FROM CESTAS;

/*10.1 - RESET DO IDENTITY DE CESTAS PARA 1*/
USE AGENCIA_ALINE;
GO
TRUNCATE TABLE CESTAS;
GO
DBCC CHECKIDENT('CESTAS', RESEED, 1);
GO

/*10.1 - RESET DO IDENTITY DE CONTRATOS PARA 1*/
USE AGENCIA_ALINE;
GO
TRUNCATE TABLE CONTRATOS;
GO
DBCC CHECKIDENT('CONTRATOS', RESEED, 1);
GO













